<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW 3 Series Exhaust Parts - AMPerformance</title>
    <link rel="stylesheet" href="../../styles.css">
    <script src="../../js/cart.js"></script>
    <script src="../../js/language.js"></script>
    <script src="../../js/navigation.js"></script>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <a href="../../index.html">
                    <img src="../../AMlLogo.png" alt="AMPerformance Logo">
                </a>
            </div>
            <div class="nav-links">
                <a href="../../brands.html" class="active" data-translate="nav.chooseCar">Izaberi Auto</a>
                <a href="../../about.html" data-translate="nav.about">O Nama</a>
                <a href="../../contact.html" data-translate="nav.contact">Kontakt</a>
                <a href="../../cart.html" class="cart-link">
                    <span data-translate="nav.cart">Korpa</span> <span class="cart-count">0</span>
                </a>
            </div>
            <div class="language-selector">
                <a href="#" data-lang="bs" class="active">BS</a>
                <a href="#" data-lang="en">EN</a>
            </div>
            <button class="burger-menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="mobile-nav">
                <a href="../../brands.html" data-translate="nav.chooseCar">Izaberi Auto</a>
                <a href="../../about.html" data-translate="nav.about">O Nama</a>
                <a href="../../contact.html" data-translate="nav.contact">Kontakt</a>
                <a href="../../cart.html" class="cart-link">
                    <span data-translate="nav.cart">Korpa</span> <span class="cart-count">0</span>
                </a>
                <div class="language-selector">
                    <a href="#" data-lang="bs" class="active">BS</a>
                    <a href="#" data-lang="en">EN</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="products-page">
        <div class="products-header">
            <h1>BMW 3 Series - <span data-translate="exhaust.title">Exhaust Parts</span></h1>
            <p data-translate="exhaust.subtitle">Pronađite savršene dijelove za vaš automobil</p>
        </div>

        <div class="engine-selector">
            <div class="selector-container">
                <h2 data-translate="engine.selectEngine">Izaberite Motor</h2>
                
                <div class="engine-type-selector">
                    <button class="engine-type-btn active" data-type="diesel" data-translate="engine.diesel">Dizel</button>
                    <button class="engine-type-btn" data-type="petrol" data-translate="engine.petrol">Benzin</button>
                </div>

                <div class="engine-variant-selector">
                    <select id="engineVariant" class="engine-dropdown">
                        <option value="" data-translate="engine.selectVariant">Izaberite varijantu motora</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="products-grid" id="productsGrid" style="display: none;">
            <!-- Products will be dynamically loaded here -->
        </div>

        <div class="no-selection-message" id="noSelectionMessage">
            <div class="message-content">
                <h3 data-translate="engine.noSelection">Molimo izaberite motor da vidite dostupne dijelove</h3>
                <p data-translate="engine.noSelectionDesc">Izaberite tip motora (Dizel/Benzin) i specifičnu varijantu da prikažemo kompatibilne dijelove za vaš BMW 3 Series.</p>
            </div>
        </div>
    </main>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <p id="modalDescription"></p>
                <p id="modalPrice"></p>
                <p id="modalEngine"></p>
            </div>
            <div class="image-gallery">
                <div class="main-image-container">
                    <img id="mainImage" src="" alt="">
                    <div class="image-nav">
                        <button id="prevImage" class="nav-btn"><</button>
                        <button id="nextImage" class="nav-btn">></button>
                    </div>
                </div>
                <div class="thumbnail-container">
                    <div id="thumbnails" class="thumbnails"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="modalAddToCart" class="add-to-cart-modal">Dodaj u Korpu</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4 data-translate="footer.contact">Kontakt</h4>
                <p>Email: amperformance.balkan@gmail.com</p>
                <p>Telefon: +387 XX XXX XXX</p>
            </div>
            <div class="footer-section">
                <h4 data-translate="footer.quickNav">Brza Navigacija</h4>
                <a href="../../brands.html" data-translate="nav.chooseCar">Izaberi Auto</a>
                <a href="../../about.html" data-translate="nav.about">O Nama</a>
                <a href="../../contact.html" data-translate="nav.contact">Kontakt</a>
            </div>
            <div class="footer-section">
                <h4 data-translate="footer.followUs">Pratite Nas</h4>
                <div class="social-links">
                    <a href="#">Facebook</a>
                    <a href="#">Instagram</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 AMPerformance. <span data-translate="footer.rights">Sva prava zadržana</span>.</p>
        </div>
    </footer>

    <script>
        // Engine data
        const engineData = {
            diesel: [
                { value: '518d', label: '518d (143hp)', years: '2012-2018' },
                { value: '520d', label: '520d (184hp)', years: '2012-2019' },
                { value: '530d', label: '530d (258hp)', years: '2012-2019' },
                { value: '535d', label: '535d (313hp)', years: '2013-2018' },
                { value: '550d', label: '535d (313hp)', years: '2013-2018' }
            ],
            petrol: [
                { value: '516i', label: '516i (136hp)', years: '2012-2018' },
                { value: '518i', label: '518i (156hp)', years: '2015-2019' },
                { value: '520i', label: '520i (184hp)', years: '2012-2019' },
                { value: '528i', label: '528i (245hp)', years: '2012-2016' },
                { value: '530i', label: '530i (252hp)', years: '2015-2019' },
                { value: '535i', label: '535i (306hp)', years: '2012-2015' },,
                { value: '550i', label: '535i (306hp)', years: '2012-2015' },
                { value: 'M5', label: 'M5 (431hp)', years: '2014-2018' }
            ]
        };

        // Product data for each engine with multiple images
        const productData = {
            '518d': [
                {
                    name: 'Wagner Downpipe 518d',
                    description: 'Catless downpipe za BMW F10 518d - povećava snagu i poboljšava zvuk motora',
                    price: 950,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Milltek Cat-Back 518d',
                    description: 'Cat-back sistem za BMW F10 518d - premium kvalitet sa sportskim zvukom',
                    price: 1800,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/1335077/pexels-photo-1335077.jpeg',
                        'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg'
                    ]
                }
            ],
            '520d': [
                {
                    name: 'Wagner Downpipe 520d',
                    description: 'Catless downpipe za BMW F10 520d - optimizovan za performanse',
                    price: 1100,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Remus Cat-Back 520d',
                    description: 'Cat-back sistem za BMW F10 520d - austrijsko inženjerstvo',
                    price: 2200,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/892522/pexels-photo-892522.jpeg',
                        'https://images.pexels.com/photos/3874337/pexels-photo-3874337.jpeg'
                    ]
                }
            ],
            '530d': [
                {
                    name: 'Wagner Downpipe 530d',
                    description: 'Catless downpipe za BMW F10 530d - maksimalne performanse',
                    price: 1300,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Akrapovic Cat-Back 530d',
                    description: 'Titanium cat-back sistem za BMW F10 530d - Formula 1 tehnologija',
                    price: 3500,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/3752169/pexels-photo-3752169.jpeg',
                        'https://images.pexels.com/photos/2127039/pexels-photo-2127039.jpeg'
                    ]
                }
            ],
            '535d': [
                {
                    name: 'Wagner Downpipe 535d',
                    description: 'Catless downpipe za BMW F10 535d - za ekstremne performanse',
                    price: 1400,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Eisenmann Cat-Back 535d',
                    description: 'Performance cat-back sistem za BMW F10 535d - njemačka preciznost',
                    price: 2800,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg',
                        'https://images.pexels.com/photos/1335077/pexels-photo-1335077.jpeg'
                    ]
                }
            ],
            '516i': [
                {
                    name: 'Milltek Cat-Back 516i',
                    description: 'Cat-back sistem za BMW F10 516i - poboljšava zvuk i performanse',
                    price: 1600,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/1335077/pexels-photo-1335077.jpeg',
                        'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg'
                    ]
                }
            ],
            '518i': [
                {
                    name: 'Remus Cat-Back 518i',
                    description: 'Cat-back sistem za BMW F10 518i - sportski zvuk sa stilom',
                    price: 1900,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/892522/pexels-photo-892522.jpeg',
                        'https://images.pexels.com/photos/3874337/pexels-photo-3874337.jpeg'
                    ]
                }
            ],
            '520i': [
                {
                    name: 'Wagner Downpipe 520i',
                    description: 'Catless downpipe za BMW F10 520i - oslobađa skrivenu snagu',
                    price: 1200,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Milltek Cat-Back 520i',
                    description: 'Cat-back sistem za BMW F10 520i - savršen balans zvuka i performansi',
                    price: 2100,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/1335077/pexels-photo-1335077.jpeg',
                        'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg'
                    ]
                }
            ],
            '528i': [
                {
                    name: 'Wagner Downpipe 528i',
                    description: 'Catless downpipe za BMW F10 528i - turbo optimizacija',
                    price: 1250,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Remus Cat-Back 528i',
                    description: 'Cat-back sistem za BMW F10 528i - premium zvuk i kvalitet',
                    price: 2400,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/892522/pexels-photo-892522.jpeg',
                        'https://images.pexels.com/photos/3874337/pexels-photo-3874337.jpeg'
                    ]
                }
            ],
            '530i': [
                {
                    name: 'Wagner Downpipe 530i',
                    description: 'Catless downpipe za BMW F10 530i - maksimalna efikasnost',
                    price: 1300,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Akrapovic Cat-Back 530i',
                    description: 'Titanium cat-back sistem za BMW F10 530i - racing tehnologija',
                    price: 3200,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/3752169/pexels-photo-3752169.jpeg',
                        'https://images.pexels.com/photos/2127039/pexels-photo-2127039.jpeg'
                    ]
                }
            ],
            '535i': [
                {
                    name: 'Wagner Downpipe 535i',
                    description: 'Catless downpipe za BMW F10 535i - twin-turbo optimizacija',
                    price: 1200,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Remus Cat-Back 535i',
                    description: 'Cat-back sistem za BMW F10 535i - agresivan zvuk za snažan motor',
                    price: 2500,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/892522/pexels-photo-892522.jpeg',
                        'https://images.pexels.com/photos/3874337/pexels-photo-3874337.jpeg'
                    ]
                },
                {
                    name: 'M Performance Tips 535i',
                    description: 'Carbon fiber završeci za BMW F10 535i - OEM M Performance stil',
                    price: 800,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg',
                        'https://images.pexels.com/photos/1335077/pexels-photo-1335077.jpeg'
                    ]
                }
            ],
            '550i': [
                {
                    name: 'Wagner Downpipe 550i',
                    description: 'Catless downpipe za BMW F10 550i - twin-turbo optimizacija',
                    price: 1200,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                },
                {
                    name: 'Remus Cat-Back 550i',
                    description: 'Cat-back sistem za BMW F10 550i - agresivan zvuk za snažan motor',
                    price: 2500,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/892522/pexels-photo-892522.jpeg',
                        'https://images.pexels.com/photos/3874337/pexels-photo-3874337.jpeg'
                    ]
                },
                {
                    name: 'M Performance Tips 550i',
                    description: 'Carbon fiber završeci za BMW F10 550i - OEM M Performance stil',
                    price: 800,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg',
                        'https://images.pexels.com/photos/1335077/pexels-photo-1335077.jpeg'
                    ]
                }
            ],
            'M5': [
                {
                    name: 'Akrapovic Evolution M5',
                    description: 'Titanium evolution sistem za BMW F10 M5 - ultimativni performance upgrade',
                    price: 5500,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/3752169/pexels-photo-3752169.jpeg',
                        'https://images.pexels.com/photos/2127039/pexels-photo-2127039.jpeg'
                    ]
                },
                {
                    name: 'Eisenmann Race M5',
                    description: 'Race cat-back sistem za BMW F10 M5 - track-ready performanse',
                    price: 4200,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg',
                        'https://images.pexels.com/photos/1335077/pexels-photo-1335077.jpeg'
                    ]
                },
                {
                    name: 'M Performance Downpipe M5',
                    description: 'OEM downpipe za BMW F10 M5 - originalni BMW M Performance dio',
                    price: 2800,
                    images: [
                        'https://images.pexels.com/photos/3778769/pexels-photo-3778769.jpeg',
                        'https://images.pexels.com/photos/919073/pexels-photo-919073.jpeg',
                        'https://images.pexels.com/photos/3846217/pexels-photo-3846217.jpeg'
                    ]
                }
            ]
        };

        let currentEngineType = 'diesel';
        let selectedEngine = '';
        let currentProduct = null;
        let currentImageIndex = 0;
        let productImageIndices = {}; // Track current image index for each product

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            setupEngineSelector();
            setupImageModal();
            updateEngineVariants();
        });

        function setupEngineSelector() {
            const engineTypeButtons = document.querySelectorAll('.engine-type-btn');
            const engineVariantSelect = document.getElementById('engineVariant');

            engineTypeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Update active button
                    engineTypeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    currentEngineType = button.dataset.type;
                    updateEngineVariants();
                    hideProducts();
                });
            });

            engineVariantSelect.addEventListener('change', (e) => {
                selectedEngine = e.target.value;
                if (selectedEngine) {
                    showProducts(selectedEngine);
                } else {
                    hideProducts();
                }
            });
        }

        function updateEngineVariants() {
            const engineVariantSelect = document.getElementById('engineVariant');
            const engines = engineData[currentEngineType];
            
            // Clear existing options
            engineVariantSelect.innerHTML = '<option value="">Izaberite varijantu motora</option>';
            
            // Add new options
            engines.forEach(engine => {
                const option = document.createElement('option');
                option.value = engine.value;
                option.textContent = `${engine.label} (${engine.years})`;
                engineVariantSelect.appendChild(option);
            });
            
            selectedEngine = '';
        }

        function showProducts(engineVariant) {
            const productsGrid = document.getElementById('productsGrid');
            const noSelectionMessage = document.getElementById('noSelectionMessage');
            const products = productData[engineVariant] || [];

            noSelectionMessage.style.display = 'none';
            productsGrid.style.display = 'grid';
            
            // Clear existing products
            productsGrid.innerHTML = '';
            
            // Reset image indices
            productImageIndices = {};
            
            // Add products
            products.forEach((product, index) => {
                const productId = `${engineVariant}-${index}`;
                productImageIndices[productId] = 0; // Start with first image
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image-container">
                        <img src="${product.images[0]}" alt="${product.name}" data-product-id="${productId}">
                        <div class="product-image-nav">
                            <button class="product-nav-btn prev-btn" data-product-id="${productId}" data-direction="prev">‹</button>
                            <button class="product-nav-btn next-btn" data-product-id="${productId}" data-direction="next">›</button>
                        </div>
                        <div class="image-indicators">
                            ${product.images.map((_, imgIndex) => 
                                `<span class="indicator ${imgIndex === 0 ? 'active' : ''}" data-product-id="${productId}" data-image-index="${imgIndex}"></span>`
                            ).join('')}
                        </div>
                    </div>
                    <h3>${product.name}</h3>
                    <p class="description">${product.description}</p>
                    <p class="price">${product.price}</p>
                    <button class="add-to-cart">Dodaj u Korpu</button>
                `;
                
                // Add click handler for modal (only on image, not navigation buttons)
                const productImage = productCard.querySelector('img');
                productImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openImageModal(product, engineVariant);
                });
                
                // Add click handlers for product card navigation
                const prevBtn = productCard.querySelector('.prev-btn');
                const nextBtn = productCard.querySelector('.next-btn');
                
                prevBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    changeProductImage(productId, product, -1);
                });
                
                nextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    changeProductImage(productId, product, 1);
                });
                
                // Add click handlers for indicators
                const indicators = productCard.querySelectorAll('.indicator');
                indicators.forEach(indicator => {
                    indicator.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const imageIndex = parseInt(indicator.dataset.imageIndex);
                        setProductImage(productId, product, imageIndex);
                    });
                });
                
                // Add click handler for add to cart
                const addToCartBtn = productCard.querySelector('.add-to-cart');
                addToCartBtn.addEventListener('click', () => {
                    const engineInfo = engineData[currentEngineType].find(e => e.value === engineVariant);
                    const carModel = `BMW 3 Series ${engineInfo.label}`;
                    addToCart(product.name, product.price, product.images[0], carModel);
                });
                
                productsGrid.appendChild(productCard);
            });
        }

        function changeProductImage(productId, product, direction) {
            const currentIndex = productImageIndices[productId];
            let newIndex = currentIndex + direction;
            
            if (newIndex >= product.images.length) {
                newIndex = 0;
            } else if (newIndex < 0) {
                newIndex = product.images.length - 1;
            }
            
            setProductImage(productId, product, newIndex);
        }

        function setProductImage(productId, product, imageIndex) {
            productImageIndices[productId] = imageIndex;
            
            // Update image
            const productImage = document.querySelector(`img[data-product-id="${productId}"]`);
            productImage.src = product.images[imageIndex];
            
            // Update indicators
            const indicators = document.querySelectorAll(`.indicator[data-product-id="${productId}"]`);
            indicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index === imageIndex);
            });
        }

        function hideProducts() {
            const productsGrid = document.getElementById('productsGrid');
            const noSelectionMessage = document.getElementById('noSelectionMessage');
            
            productsGrid.style.display = 'none';
            noSelectionMessage.style.display = 'block';
        }

        function setupImageModal() {
            const modal = document.getElementById('imageModal');
            const closeBtn = document.querySelector('.close');
            const prevBtn = document.getElementById('prevImage');
            const nextBtn = document.getElementById('nextImage');

            closeBtn.addEventListener('click', closeImageModal);
            prevBtn.addEventListener('click', () => changeImage(-1));
            nextBtn.addEventListener('click', () => changeImage(1));

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeImageModal();
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (modal.style.display === 'block') {
                    if (e.key === 'Escape') closeImageModal();
                    if (e.key === 'ArrowLeft') changeImage(-1);
                    if (e.key === 'ArrowRight') changeImage(1);
                }
            });
        }

        function openImageModal(product, engineVariant) {
            currentProduct = product;
            currentImageIndex = 0;
            
            const modal = document.getElementById('imageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const modalPrice = document.getElementById('modalPrice');
            const modalEngine = document.getElementById('modalEngine');
            const modalAddToCart = document.getElementById('modalAddToCart');

            // Set product info
            modalTitle.textContent = product.name;
            modalDescription.textContent = product.description;
            modalPrice.textContent = `${product.price} KM`;
            
            const engineInfo = engineData[currentEngineType].find(e => e.value === engineVariant);
            modalEngine.textContent = `Za: BMW 3 Series ${engineInfo.label}`;

            // Setup add to cart button
            modalAddToCart.onclick = () => {
                const carModel = `BMW 3 Series ${engineInfo.label}`;
                addToCart(product.name, product.price, product.images[0], carModel);
                closeImageModal();
            };

            // Setup images
            updateModalImages();
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentProduct = null;
        }

        function changeImage(direction) {
            if (!currentProduct) return;
            
            currentImageIndex += direction;
            
            if (currentImageIndex >= currentProduct.images.length) {
                currentImageIndex = 0;
            } else if (currentImageIndex < 0) {
                currentImageIndex = currentProduct.images.length - 1;
            }
            
            updateModalImages();
        }

        function updateModalImages() {
            if (!currentProduct) return;
            
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.getElementById('thumbnails');
            
            // Update main image
            mainImage.src = currentProduct.images[currentImageIndex];
            mainImage.alt = currentProduct.name;
            
            // Update thumbnails
            thumbnails.innerHTML = '';
            currentProduct.images.forEach((image, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = image;
                thumbnail.alt = `${currentProduct.name} ${index + 1}`;
                thumbnail.className = index === currentImageIndex ? 'thumbnail active' : 'thumbnail';
                thumbnail.addEventListener('click', () => {
                    currentImageIndex = index;
                    updateModalImages();
                });
                thumbnails.appendChild(thumbnail);
            });
        }
    </script>
</body>
</html>